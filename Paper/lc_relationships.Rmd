---
output: pdf_document
---

# Relationships

In the sections above we explored covariance at a single moment, general trends, and covariance between trends. Here, we explore relationship patterns between two variables over time. Does affect relate to performance across time? Over time, does unit climate covary with shared mental models? Do the fluctuations in voice match the fluctuations in commitment over time -- i.e., when voice is high is commitment also high? 

Our first inference focuses on a single unit -- one person, one team, or one organization over time. The trajectory of a single unit over time is called a time-series, and two are plotted simultaneously in figure \ref{relation_ts}. The solid line shows a time-series of affect over time, and the dashed line plots a time-series of performance. Notice that, across time, when affect is high respective to itself performance is also high (and vice versa). The colored squares represent values of each variable at different points in time. The green squares highlight low values of both variables, the blue high values, and the red middle values. 

\begin{center}

------------

Insert Figure \ref{relation_ts} about here

------------

\end{center}

Panel B shows how those respective values map onto a scatterplot of affect and performance -- which again will lead to the inference. The blue values indicate that high values of affect tend to co-occur with high values of performance (shown respectively by the blue squares in Panel A). The red values indicate that middle values of affect tend to co-occur with middle values of performance. The green values, finally, indicate that low values of affect tend to co-occur with low values of performance. Across time, affect and performance covary and the relationship is positive. 

>> **Inference 1:** There is a relationship between $x$ and $y$ across time. 

What happens when we add more units? Doing so changes the question from "what is the relationship across time" to, "at each moment, what is the relationship across units?" Ultimately we move from a within-unit question to a between-unit focus, and we apply that between unit focus to each time point. 

In the prior inference we asked if affect relates to performance across time -- on a single person/unit. Now imagine that we gather data on multiple people across time, so we have many affect and performance trajectories. One of the most popular inferences in our literature is to take those time series and slice them into individual time points, look at between-person correlations among affect and performance at a single moment, and then repeat that analysis for each time point. At time one, what is the correlation between affect and performance? At time two, what is the correlation between affect and performance? At time three, what is the correlation between affect and performance? Because we have multiple people we can explore correlations at a single moment. Researchers then typically report the average of these single moment correlations, or they constrain them to be equal across time. 

Figure \ref{relation_tvc} shows the inference with data. Panel A plots affect and performance trajectories for each person. The red circles in Panel A highlight each individual's affect and performance values at time point six. Given that we have three people for time point six, we can calculate a correlation between affect and performance at that moment (granted, it is a small sample). The calculated correlation coefficient is then mapped onto panel B with another red circle. At time point six, the correlation between affect and performance across people is large and positive.

\begin{center}

------------

Insert Figure \ref{relation_tvc} about here

------------

\end{center}

Panel B then shows correlation coefficients for the rest of the time points. Often these correlations are either averaged over time or constrained to be equal. Again, this second inference is one of the most common inferences in our literature -- when a researcher uses a time-varying covariates, hierarchical linear, random-coefficient, or multi-level model on longitudinal data to explore relationships among one or more variables (and they are not evoking a growth curve) they are more than likely making this inference.

>> **Inference 2:** There is a relationship between $x$ and $y$ across units over time.

## Relationships Inference Table

Table \ref{relationships_table} reports example inferences with respect to relationships. Inference one focuses on within-unit relationships across time, whereas inference two focuses on between-unit relationships at each moment. 

\begin{center}

------------

Insert Table \ref{relationships_table} about here

------------

\end{center}

## Models

Time-varying or invariant covariates analyses.




```{r, echo = F}
library(xtable)
library(knitr)
library(kableExtra)
library(tidyverse)

inference_text <- c('There is a relationship between x and y across time.',
                    'There is a relationship between x and y across units over time')
level_table <- data.frame(
  Inference = c(1, 2),
  Examples = c(linebreak('Affect relates to performance across time.\nHelping behaviors predict depletion across time.'),
                         'Affect relates to performance across people (and it is consistent over time/and averaged over time it is positive).'))

level_table %>%
  kable('latex', booktabs = T, escape = F, align = 'l', caption = '\\label{relationships_table}Examples of Relationship inferences.') %>%
    column_spec(1, width = '5em') %>%
    column_spec(2, width = '30em') %>%
  row_spec(1, hline_after = T)


```


```{r, echo = F, fig.cap = 'Relating affect to performance on one unit across time.\\label{relation_ts}', fig.height = 8}
library(tidyverse)
set.seed(2)
timer <- 20
da <- matrix(, ncol = 3, nrow = timer)

for(i in 1:timer){
  
  if(i < 6){
  da[i, 1] <- i
  da[i, 2] <- 3 + rnorm(1, 0, 4)
  da[i, 3] <- 19 + rnorm(1, 0, 1) + 0.6* da[i, 2]
  }else if (i > 5 & i < 11){
    
    da[i, 1] <- i
    da[i, 2] <- 16 + rnorm(1,0,1)
    da[i, 3] <- 32 + rnorm(1,0,1) + 0.6*da[i, 2]
  } else{
    
      da[i, 1] <- i
      da[i, 2] <- 3 + rnorm(1, 0, 4)
      da[i, 3] <- 6 + rnorm(1, 0, 1) + 0.6* da[i, 2]
    
  }
}

da <- data.frame(da)
names(da) <- c('Time', 'Affect', 'Performance')
da <- da %>%
  gather(Affect, Performance, key = 'Variable', value = 'Value')

library(ggplot2)

g1 <- ggplot(da, aes(x = Time, y = Value, group = Variable)) + 
  geom_line(aes(linetype = Variable)) + 
  theme_classic() + 
  scale_y_continuous(labels = NULL) + 
  geom_rect(aes(xmin = 2, xmax = 4, ymin = 3, ymax = 6), fill = 'red', alpha = 0.03) + 
  #geom_segment(aes(x = 3, xend = 3, y = 5, yend = 21), color = 'blue', alpha = 0.5, linetype = 'dashed') + 
  geom_rect(aes(xmin = 2, xmax = 4, ymin = 20, ymax = 23), fill = 'red', alpha = 0.03) + 
  geom_rect(aes(xmin = 18, xmax = 20, ymin = 3, ymax = 6), fill = 'green', alpha = 0.03) + 
  #geom_segment(aes(x = 17, xend = 17, y = 19, yend = 32), color = 'blue', alpha = 0.5, linetype = 'dashed') + 
  geom_rect(aes(xmin = 18, xmax = 20, ymin = -2, ymax = 1), fill = 'green', alpha = 0.03) + 
  geom_rect(aes(xmin = 7, xmax = 9, ymin = 40, ymax = 43), fill = 'blue', alpha = 0.03) + 
  geom_rect(aes(xmin = 7, xmax = 9, ymin = 16, ymax = 19), fill = 'blue', alpha = 0.03) + 
  ggtitle('Panel A')

affect_line <- c(1:21)
perf_line <- affect_line*0.7 + rnorm(21, 0, 1)
lin_df <- data.frame(
  'Affect' = c(affect_line),
  'Performance' = c(perf_line),
  'label' = c(rep('green', 7), rep('red', 7), rep('blue', 7)))

g2 <- ggplot(lin_df, aes(x = Affect, y = Performance, color = label)) + 
  geom_point(size = 2, alpha = 0.6) + 
  theme_classic() + 
  scale_x_continuous(labels = NULL) + 
  scale_y_continuous(labels = NULL) + 
  scale_color_manual(values = c('blue' = 'blue',
                                'green' = 'green',
                                'red' = 'red')) + 
  theme(legend.position = 'none') + 
  ggtitle('Panel B')

library(gridExtra)

grid.arrange(g1, g2, ncol = 1)
```




```{r, echo = F, fig.cap = 'Relating affect to performance across units over time. The red circles demonstrate the between unit correlation for time point six. A typical time-varying covariates model constrains the correlation to be equivalent across time. Here, the relationship is unconstrained at each time point.\\label{relation_tvc}', fig.height = 8}
library(ggplot2)
set.seed(94)

time <- c(1:20)
r_affect <- c(8 + rnorm(20,0,1))
r_perf <- c(6 + rnorm(20,0,1))

r_affect2 <- c(2 + rnorm(20,0,1))
r_perf2 <- c(4 + rnorm(20,0,1))

r_affect3 <- c(5 + rnorm(20,0,1))
r_perf3 <- c(4.8 + rnorm(20,0,1))

rel_df <- data.frame(
  'Time' = c(time, time, time, time, time, time),
  'Value' = c(r_affect, r_perf,
          r_affect2, r_perf2,
          r_affect3, r_perf3),
  'call' = c(rep('Affect', 20),
              rep('Performance', 20),
             rep('Affect', 20),
             rep('Performance', 20),
             rep('Affect', 20),
             rep('Performance', 20)),
  'Person' = c(rep('Person 1', 40),
               rep('Person 2', 40),
               rep('Person 3', 40)))


library(tidyverse)

untidy_df <- rel_df %>% 
    spread(Value, key = call) 

untidy_df <- untidy_df %>%
  group_by(Time) %>%
  summarise(
    cor_ap = cor(Affect, Performance)
  )


library(data.table)
selector <- data.table(rel_df)
#selector[selector[, Person == 'Person 1' & Time == 6 & call == 'Affect'], 2]
#as.numeric(selector[selector[, Person == 'Person 1' & Time == 6 & call == 'Affect'], 2])



label_data <- data.frame(
  'Time' = c(6,6,6,6,6,6),
  'Label' = c(
    # affect person 1
    as.numeric(selector[selector[, Person == 'Person 1' & Time == 6 & call == 'Affect'], 2]),
    # affect person 2
    as.numeric(selector[selector[, Person == 'Person 2' & Time == 6 & call == 'Affect'], 2]),
    # affect person 3
    as.numeric(selector[selector[, Person == 'Person 3' & Time == 6 & call == 'Affect'], 2]),
    # performance person 1
    as.numeric(selector[selector[, Person == 'Person 1' & Time == 6 & call == 'Performance'], 2]),
    # performance person 2
    as.numeric(selector[selector[, Person == 'Person 2' & Time == 6 & call == 'Performance'], 2]),
    # performance person 3
    as.numeric(selector[selector[, Person == 'Person 3' & Time == 6 & call == 'Performance'], 2])

  ),
  'call' = c('Affect', 'Affect','Affect',
             'Performance', 'Performance', 'Performance'),
  'Person' = c('Person 1', 'Person 2', 'Person 3', 'Person 1', 'Person 2', 'Person 3')
  
)

relate1 <- ggplot(rel_df, aes(x = Time, y = Value, group = call)) + 
  #geom_smooth(aes(linetype = call), se = F, color = 'black', span = 0.4) + 
  geom_line(aes(linetype = call)) + 
  theme_classic() + 
  scale_y_continuous(labels = NULL) + 
  theme(legend.title = element_blank()) + 
  facet_grid(~Person, scales = 'free', space = 'free') + 
  geom_point(data = label_data, size = 4, colour = 'red', aes(y = Label), show.legend = F, alpha = 0.6) + 
  ggtitle('Panel A')


point_it <- data.frame(
  'Time' = c(6),
  'boom' = c(untidy_df[untidy_df$Time == 6, 2])
)
names(point_it) <- c('Time', 'boom')

relate2 <- ggplot(untidy_df, aes(x = Time, y = cor_ap)) + 
  geom_point(size = 4, alpha = 0.6) + 
  theme_classic() + 
  ylab("Affect and Performance Correlation Across People") + 
  xlab("Time") + 
  ggtitle('Panel B') + 
  theme(legend.title = element_blank()) +
  scale_y_continuous(limits = c(-0.12, 1.02),
                     breaks = c(0, 0.5, 1)) + 
  theme(
    axis.ticks = element_blank()
  ) + 
  geom_point(data = point_it, color = 'red', size = 4, aes(x = Time, y = boom), show.legend = F, alpha = 0.6)

library(gridExtra)

grid.arrange(relate1, relate2, ncol = 1)

```